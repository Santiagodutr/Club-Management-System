---
// Deshabilitar prerender para evitar conexi√≥n a DB en build time
export const prerender = false

import BaseLayout from '../layouts/BaseLayout.astro'
import millanuraImg from '../assets/millanura.jpg'
import barImg from '../assets/bar.jpg'
import empresarialImg from '../assets/empresarial.jpg'
import terrazaImg from '../assets/terraza.jpg'
import kioskoImg from '../assets/kiosko.jpg'
import presidencialImg from '../assets/presidencial.jpg'

const imageMap = {
  'MI LLANURA': millanuraImg,
  'BAR': barImg,
  'EMPRESARIAL': empresarialImg,
  'TERRAZA': terrazaImg,
  'KIOSKO': kioskoImg,
  'PRESIDENTE': presidencialImg,
}

// Datos est√°ticos para build
const espacios = [
  { id: 1, nombre: 'MI LLANURA', capacidadMaxima: 100 },
  { id: 2, nombre: 'BAR', capacidadMaxima: 60 },
  { id: 3, nombre: 'EMPRESARIAL', capacidadMaxima: 35 },
  { id: 4, nombre: 'TERRAZA', capacidadMaxima: 30 },
  { id: 5, nombre: 'KIOSKO', capacidadMaxima: 60 },
  { id: 6, nombre: 'PRESIDENTE', capacidadMaxima: 15 },
]
---

<BaseLayout title="Obtener cotizaci√≥n - Club del Meta" fullWidth>
  <section class="cotizacion">
    <header class="cotizacion__header">
      <div class="cotizacion__badge">Servicio Personalizado</div>
      <h1>
        <span class="title-top">SOLICITA TU</span>
        <span class="title-main">COTIZACI√ìN</span>
      </h1>
      <p>Selecciona el sal√≥n, completa los datos y recibe tu propuesta personalizada al instante.</p>
    </header>

    <div class="cotizacion__container">
      <aside class="cotizacion__media">
        <img id="salon-image" src={millanuraImg.src} alt="Imagen del sal√≥n seleccionado" />
        <div class="salon-info">
          <h2 id="salon-title">MI LLANURA</h2>
          <p id="salon-description">Sal√≥n insignia con vista a las √°reas verdes, ambientaci√≥n adaptable. Ideal para recepciones, matrimonios y eventos corporativos.</p>
          <ul id="salon-features">
            <li id="capacidad-info">Capacidad: hasta 100 personas</li>
            <li id="precio-4h-info">4 horas: Cargando...</li>
            <li id="precio-8h-info">8 horas: Cargando...</li>
          </ul>
        </div>
      </aside>

      <main class="cotizacion__form">
        <form id="cotizacion-form">
          <!-- Paso 1: Selecci√≥n del Sal√≥n y Configuraci√≥n -->
          <div class="form-section">
            <h3>1. Sal√≥n y Configuraci√≥n</h3>
            
            <div class="field">
              <label for="salon">Sal√≥n *</label>
              <select id="salon" name="salon" required>
                {espacios.map((espacio) => {
                  const imgSrc = imageMap[espacio.nombre]?.src || millanuraImg.src
                  return (
                    <option 
                      value={JSON.stringify({ id: espacio.id, nombre: espacio.nombre })} 
                      data-img={imgSrc}
                      data-capacidad={espacio.capacidadMaxima}
                    >
                      {espacio.nombre}
                    </option>
                  )
                })}
              </select>
            </div>

            <div class="field">
              <label for="disposicion">Disposici√≥n del Sal√≥n *</label>
              <select id="disposicion" name="disposicion" required>
                <option value="">Selecciona una disposici√≥n</option>
              </select>
            </div>

            <!-- Secci√≥n desplegable de explicaci√≥n de disposiciones -->
            <details class="disposiciones-explicacion" id="disposiciones-info">
              <summary>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                ¬øQu√© significan las disposiciones?
              </summary>
              <div class="disposiciones-contenido" id="disposiciones-contenido">
                <p style="text-align: center; color: #64748b;">Cargando disposiciones...</p>
              </div>
            </details>
          </div>

          <!-- Paso 2: Fecha, Hora y Duraci√≥n -->
          <div class="form-section">
            <h3>2. Fecha y Hora</h3>
            
            <div class="field grid-2">
              <div>
                <label for="date">Fecha del Evento *</label>
                <input id="date" name="date" type="date" required />
                <small id="horario-info" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #ecfdf5; border-left: 3px solid #10b981; color: #065f46; border-radius: 4px;"></small>
              </div>
              <div>
                <label for="time">Hora de Inicio *</label>
                <select id="time" name="time" required disabled>
                  <option value="">Selecciona primero fecha y sal√≥n</option>
                </select>
                <small id="horas-info" style="display: none; margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></small>
              </div>
            </div>

            <div class="field grid-2">
              <div>
                <label for="duration">Duraci√≥n (horas) * - M√≠nimo 4h, M√°ximo 8h</label>
                <input id="duration" name="duration" type="number" min="4" max="8" value="4" required />
                <small>Las horas adicionales a 8 se cobran por separado</small>
              </div>
              <div>
                <label>Hora Final</label>
                <input id="hora-final" type="text" readonly disabled style="background: #f3f4f6; color: #6b7280; cursor: not-allowed;" value="Selecciona hora de inicio" />
                <small id="duracion-info" style="display: none; margin-top: 0.5rem; font-size: 0.875rem; color: #10b981;"></small>
              </div>
            </div>
          </div>

          <!-- Paso 3: Tipo de Evento y Asistentes -->
          <div class="form-section">
            <h3>3. Tipo de Evento</h3>
            
            <div class="field grid-2">
              <div>
                <label for="tipoEvento">Tipo de Evento *</label>
                <select id="tipoEvento" name="tipoEvento" required>
                  <option value="">Selecciona un tipo</option>
                  <option value="social">Social (Matrimonio, Cumplea√±os, Reuni√≥n)</option>
                  <option value="empresarial">Empresarial (Conferencia, Reuni√≥n)</option>
                  <option value="capacitacion">Capacitaci√≥n / Workshop</option>
                </select>
              </div>
              <div>
                <label for="asistentes">Cantidad de Asistentes * <span id="capacidad-info-text"></span></label>
                <input id="asistentes" name="asistentes" type="number" min="1" value="50" required />
              </div>
            </div>

            <!-- Campo Soy Socio -->
            <div class="field">
              <label class="checkbox-label">
                <input type="checkbox" id="soy-socio" name="soySocio" />
                <span>Soy socio del club</span>
              </label>
            </div>

            <!-- Campo C√≥digo de Socio (inicialmente oculto) -->
            <div class="field" id="codigo-socio-container" style="display: none;">
              <label for="codigo-socio">C√≥digo de Socio *</label>
              <div class="verification-group">
                <div class="verification-input-wrapper">
                  <input 
                    id="codigo-socio" 
                    name="codigoSocio" 
                    type="text" 
                    placeholder="Ingresa tu c√≥digo de socio"
                    autocomplete="off"
                  />
                  <small id="codigo-socio-mensaje" style="display: none;"></small>
                </div>
                <button 
                  type="button" 
                  id="verificar-codigo-btn" 
                  class="btn-verify"
                >
                  Verificar
                </button>
              </div>
            </div>
          </div>

          <!-- Paso 4: Servicios Adicionales -->
          <div class="form-section">
            <h3>4. Servicios Adicionales</h3>
            
            <div class="checkboxes" id="servicios-checkboxes">
              <!-- Los servicios se cargar√°n desde el backend -->
            </div>
          </div>

          <!-- Paso 5: Informaci√≥n de Contacto -->
          <div class="form-section">
            <h3>5. Informaci√≥n de Contacto</h3>
            
            <div class="field">
              <label for="nombre">Nombre de Contacto *</label>
              <input id="nombre" name="nombre" type="text" required />
            </div>

            <div class="field grid-2">
              <div>
                <label for="email">Email *</label>
                <input id="email" name="email" type="email" required />
              </div>
              <div>
                <label for="telefono">Tel√©fono</label>
                <input id="telefono" name="telefono" type="tel" />
              </div>
            </div>

            <div class="field">
              <label for="observaciones">Observaciones Adicionales</label>
              <textarea id="observaciones" name="observaciones" rows="3" placeholder="Especifica detalles particulares de tu evento..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn-primary">Solicitar</button>
            <button type="reset" class="btn-secondary">Limpiar Formulario</button>
          </div>
        </form>

        <!-- Mensaje de √âxito -->
        <div id="success-message" class="message success-message" hidden>
          <div class="message-header">
            <h3>‚úì ¬°Cotizaci√≥n Generada!</h3>
          </div>
          <div class="message-content">
            <p><strong>N√∫mero de Cotizaci√≥n:</strong> <span id="cotizacion-numero"></span></p>
            <p><strong>Valor Total:</strong> <span id="cotizacion-total"></span></p>
            <p><strong>Monto de Abono (50%):</strong> <span id="cotizacion-abono"></span></p>
          </div>
          <div class="message-actions">
            <button type="button" id="view-pdf-btn" class="btn-primary">Ver Cotizaci√≥n en PDF</button>
            <button type="button" id="download-pdf-btn" class="btn-secondary">Descargar PDF</button>
            <button type="button" id="nueva-cotizacion-btn" class="btn-tertiary">Hacer Otra Cotizaci√≥n</button>
          </div>
        </div>

        <!-- Mensaje de Error -->
        <div id="error-message" class="modal-error" hidden>
          <div class="modal-error__overlay"></div>
          <div class="modal-error__content">
            <button type="button" id="close-error-btn" class="modal-error__close" aria-label="Cerrar">‚úï</button>
            <div class="modal-error__icon">‚ö†</div>
            <h2 class="modal-error__title">Algo Sali√≥ Mal</h2>
            <p class="modal-error__message" id="error-text"></p>
            <div class="modal-error__actions">
              <button type="button" id="retry-btn" class="btn-primary">Intentar Nuevamente</button>
            </div>
          </div>
        </div>

        <!-- Modal de Confirmaci√≥n -->
        <div id="confirmation-modal" class="modal-confirmation" hidden>
          <div class="modal-confirmation__overlay"></div>
          <div class="modal-confirmation__content">
            <button type="button" id="close-confirmation-btn" class="modal-confirmation__close" aria-label="Cerrar">‚úï</button>
            <div class="modal-confirmation__icon">üìã</div>
            <h2 class="modal-confirmation__title">Confirmar Solicitud</h2>
            <p class="modal-confirmation__subtitle">Por favor revisa los datos antes de enviar tu solicitud:</p>
            <div class="modal-confirmation__details">
              <div class="detail-row">
                <span class="detail-label">Sal√≥n:</span>
                <span class="detail-value" id="confirm-salon"></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Fecha:</span>
                <span class="detail-value" id="confirm-fecha"></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Hora de inicio:</span>
                <span class="detail-value" id="confirm-hora-inicio"></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Hora de finalizaci√≥n:</span>
                <span class="detail-value" id="confirm-hora-fin"></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Duraci√≥n:</span>
                <span class="detail-value" id="confirm-duracion"></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Asistentes:</span>
                <span class="detail-value" id="confirm-asistentes"></span>
              </div>
              <div class="detail-row" id="confirm-socio-row" style="display: none;">
                <span class="detail-label">Tipo de cliente:</span>
                <span class="detail-value" id="confirm-socio">Socio del club</span>
              </div>
              <div class="detail-row" id="confirm-servicios-row">
                <span class="detail-label">Servicios adicionales:</span>
                <span class="detail-value" id="confirm-servicios"></span>
              </div>
            </div>
            <div class="modal-confirmation__actions">
              <button type="button" id="cancel-confirmation-btn" class="btn-secondary">Cancelar</button>
              <button type="button" id="submit-confirmation-btn" class="btn-primary">Confirmar y Enviar</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </section>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap');

    .cotizacion {
      padding: 8rem 2rem;
      max-width: 1600px;
      margin: 0 auto;
      font-family: 'Outfit', sans-serif;
    }

    .cotizacion__header {
      text-align: center;
      margin-bottom: 6rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .cotizacion__badge {
      display: inline-block;
      padding: 0.5rem 1.25rem;
      background: rgba(10, 75, 165, 0.1);
      color: #0a4ba5;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 2rem;
    }

    .cotizacion__header h1 {
      font-family: 'Bebas Neue', sans-serif;
      line-height: 0.9;
      margin: 0 0 1.5rem;
    }

    .title-top {
      display: block;
      font-size: clamp(2rem, 5vw, 3rem);
      color: #94a3b8;
      letter-spacing: 0.05em;
    }

    .title-main {
      display: block;
      font-size: clamp(4rem, 10vw, 7rem);
      color: #041a4a;
      letter-spacing: 0.02em;
    }

    .cotizacion__header p {
      color: #64748b;
      font-size: clamp(1.1rem, 2vw, 1.25rem);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .cotizacion__container {
      display: grid;
      grid-template-columns: 450px 1fr;
      gap: 4rem;
      align-items: start;
    }

    /* Sidebar / Media section */
    .cotizacion__media {
      position: sticky;
      top: 2rem;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 32px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.04);
      animation: fadeInLeft 0.8s ease-out;
    }

    .cotizacion__media img {
      width: 100%;
      height: 300px;
      border-radius: 20px;
      object-fit: cover;
      margin-bottom: 2rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      transition: transform 0.5s ease;
    }

    .cotizacion__media:hover img {
      transform: scale(1.02);
    }

    .salon-info h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.5rem;
      color: #041a4a;
      margin: 0 0 1rem;
      letter-spacing: 0.02em;
    }

    .salon-info p {
      font-size: 1rem;
      line-height: 1.7;
      color: #64748b;
      margin-bottom: 2rem;
    }

    .salon-info ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .salon-info li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-weight: 500;
      color: #1e293b;
    }

    .salon-info li:last-child { border-bottom: none; }

    /* Form Section */
    .cotizacion__form {
      background: white;
      border-radius: 40px;
      padding: 4rem;
      box-shadow: 0 40px 100px rgba(4, 26, 74, 0.05);
      border: 1px solid #f1f5f9;
      animation: fadeInRight 0.8s ease-out;
    }

    .form-section {
      margin-bottom: 4rem;
      position: relative;
    }

    .form-section h3 {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.25rem;
      color: #041a4a;
      margin-bottom: 2.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .form-section h3::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, #e2e8f0, transparent);
    }

    .field { margin-bottom: 2rem; }

    label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      color: #475569;
      margin-bottom: 0.75rem;
      letter-spacing: 0.01em;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 1rem 1.25rem;
      border-radius: 16px;
      border: 2px solid #f1f5f9;
      background: #f8fafc;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      color: #1e293b;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
      height: 58px;
    }

    textarea {
      height: auto;
      min-height: 120px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #0a4ba5;
      background: white;
      box-shadow: 0 0 0 4px rgba(10, 75, 165, 0.1);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3.5rem;
    }

    /* Checkboxes & Socio */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 16px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .checkbox-label:hover {
      background: #f1f5f9;
      border-color: #e2e8f0;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #0a4ba5;
    }

    .checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    /* Buttons */
    .actions {
      display: flex;
      gap: 1.5rem;
      margin-top: 4rem;
    }

    .btn-primary {
      background: #0a4ba5;
      color: white;
      padding: 1.25rem 3rem;
      border-radius: 16px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.2, 0, 0.2, 1);
      box-shadow: 0 10px 20px rgba(10, 75, 165, 0.2);
    }

    .btn-primary:hover {
      background: #083a82;
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(10, 75, 165, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #475569;
      padding: 1.25rem 2.5rem;
      border-radius: 16px;
      font-weight: 600;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      border-color: #0a4ba5;
      color: #0a4ba5;
      background: #f8fafc;
    }

    /* ================================================
       MODAL WRAPPERS ‚Äî fixed overlay + backdrop
       ================================================ */
    .modal-confirmation,
    .modal-error {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: modalFadeIn 0.25s ease-out;
    }

    .modal-confirmation__overlay,
    .modal-error__overlay {
      position: fixed;
      inset: 0;
      background: rgba(4, 26, 74, 0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: -1;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    @keyframes modalSlideUp {
      from { opacity: 0; transform: translateY(24px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ================================================
       MODAL CONTENT CARDS
       ================================================ */
    .modal-confirmation__content,
    .modal-error__content {
      position: relative;
      background: white;
      border-radius: 32px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 40px 100px rgba(4, 26, 74, 0.18), 0 8px 24px rgba(0,0,0,0.08);
      padding: 3rem 2.5rem 2.5rem;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Close button */
    .modal-confirmation__close,
    .modal-error__close {
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: #f1f5f9;
      color: #64748b;
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      padding: 0;
    }

    .modal-confirmation__close:hover,
    .modal-error__close:hover {
      background: #e2e8f0;
      color: #0f172a;
      transform: scale(1.08);
    }

    /* Icon */
    .modal-confirmation__icon,
    .modal-error__icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
      text-align: center;
    }

    /* Title */
    .modal-confirmation__title,
    .modal-error__title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.25rem;
      letter-spacing: 0.02em;
      color: #041a4a;
      text-align: center;
      margin: 0 0 0.5rem;
    }

    /* Subtitle */
    .modal-confirmation__subtitle {
      color: #64748b;
      font-size: 0.95rem;
      text-align: center;
      margin: 0 0 2rem;
      line-height: 1.6;
    }

    /* Details box */
    .modal-confirmation__details {
      background: #f8fafc;
      border: 1px solid #f1f5f9;
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .detail-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      border-bottom: 1px solid #f1f5f9;
      padding: 0.75rem 0;
    }

    .detail-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .detail-row:first-child {
      padding-top: 0;
    }

    .detail-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .detail-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #0f172a;
      text-align: right;
    }

    /* Modal actions */
    .modal-confirmation__actions,
    .modal-error__actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Error message text */
    .modal-error__message {
      color: #475569;
      font-size: 1rem;
      text-align: center;
      margin: 0.5rem 0 2rem;
      line-height: 1.6;
    }

    /* Success message card */
    .message {
      background: white;
      border-radius: 32px;
      border: 1px solid #f1f5f9;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.08);
      padding: 3rem;
      margin-top: 2rem;
    }

    .message-header h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      color: #059669;
      margin: 0 0 1.5rem;
      letter-spacing: 0.02em;
    }

    .message-content p {
      margin: 0.75rem 0;
      color: #1e293b;
      font-size: 1.05rem;
    }

    .message-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 2.5rem;
    }

    .btn-tertiary {
      background: transparent;
      color: #64748b;
      padding: 1.25rem 2rem;
      border-radius: 16px;
      font-weight: 600;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
    }

    .btn-tertiary:hover {
      color: #0a4ba5;
      border-color: #0a4ba5;
      background: #f0f4ff;
    }

    /* Animations */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @media (max-width: 1200px) {
      .cotizacion__container { grid-template-columns: 1fr; }
      .cotizacion__media { position: relative; top: 0; max-width: 600px; margin: 0 auto; }
    }

    @media (max-width: 768px) {
      .cotizacion { padding: 4rem 1.5rem; }
      .cotizacion__form { padding: 2rem; }
      .grid-2 { grid-template-columns: 1fr; }
      .actions { flex-direction: column; }
      .btn-primary, .btn-secondary { width: 100%; }
      .title-main { font-size: 3.5rem; }
    }

    /* Redise√±o de Verificaci√≥n de Socio */
    .verification-group {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      margin-top: 0.5rem;
    }

    .verification-input-wrapper {
      flex: 1;
      position: relative;
    }

    .btn-verify {
      padding: 0 2rem;
      height: 58px; /* Exactamente igual al input */
      background: #f1f5f9;
      color: #041a4a;
      border: 2px solid #f1f5f9; /* Mismo color de borde que el input */
      border-radius: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-verify:hover:not(:disabled) {
      background: #e2e8f0;
      border-color: #cbd5e1;
      color: #0a4ba5;
    }

    .btn-verify:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #codigo-socio-mensaje {
      display: block;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 10px;
    }

    #codigo-socio-mensaje.valido {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    #codigo-socio-mensaje.invalido {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    /* Estilos para la secci√≥n de explicaci√≥n de disposiciones */
    .disposiciones-explicacion {
      margin-top: 2rem;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      overflow: hidden;
      background: #f8fafc;
      transition: all 0.3s ease;
    }

    .disposiciones-explicacion:hover {
      border-color: #cbd5e1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .disposiciones-explicacion summary {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: #041a4a;
      font-size: 1rem;
      transition: all 0.2s;
      list-style: none;
    }

    .disposiciones-explicacion summary::-webkit-details-marker { display: none; }

    .disposiciones-explicacion summary:hover { background: #f1f5f9; }

    .disposiciones-explicacion[open] summary {
      background: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
    }

    .disposiciones-contenido {
      padding: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      background: white;
      animation: slideDown 0.4s ease-out;
    }

    .disposicion-card {
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      background: #f8fafc;
      border: 1px solid #f1f5f9;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .disposicion-card:hover {
      border-color: #0a4ba5;
      background: white;
      box-shadow: 0 10px 20px rgba(10, 75, 165, 0.05);
      transform: translateY(-5px);
    }

    .disposicion-card-titulo {
      display: block;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.25rem;
      color: #041a4a;
      margin-bottom: 0.75rem;
      letter-spacing: 0.05em;
    }

    .disposicion-card-descripcion {
      font-size: 0.9rem;
      color: #64748b;
      line-height: 1.6;
    }

    #horario-info {
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      font-size: 0.95rem;
      margin-top: 1rem;
      display: none;
    }

    [hidden] {
      display: none !important;
    }

    /* ESTILOS PARA MODALES GENERALES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-overlay.show {
      opacity: 1;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 2.5rem;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
      transform: translateY(-30px) scale(0.95);
      transition: all 0.2s ease;
    }

    .modal-overlay.show .modal {
      transform: translateY(0) scale(1);
    }

    .modal__content {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .modal__content h3 {
      margin: 0 0 1rem;
      font-size: 1.3rem;
      color: #0f172a;
    }

    .modal__content p {
      margin: 0;
      color: #475569;
      font-size: 1rem;
      line-height: 1.6;
    }

    .modal__icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: inline-block;
    }

    .modal__content--success .modal__icon {
      color: #10b981;
    }

    .modal__content--error .modal__icon {
      color: #dc2626;
    }

    .modal__content--info .modal__icon {
      color: #0a4ba5;
    }

    .modal__input {
      width: 100%;
      padding: 0.75rem;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .modal__input:focus {
      outline: none;
      border-color: #0a4ba5;
      box-shadow: 0 0 0 3px rgba(10, 75, 165, 0.1);
    }

    .modal__actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .modal__actions .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal__actions .btn.primary {
      background: #0a4ba5;
      color: white;
    }

    .modal__actions .btn.primary:hover {
      background: #083a82;
      box-shadow: 0 4px 12px rgba(10, 75, 165, 0.3);
    }

    .modal__actions .btn.secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .modal__actions .btn.secondary:hover {
      background: #d1d5db;
    }

    .modal__actions .btn.danger {
      background: #dc2626;
      color: white;
    }

    .modal__actions .btn.danger:hover {
      background: #b91c1c;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    @media (max-width: 1024px) { 
      .cotizacion__container { 
        grid-template-columns: 1fr; 
      }
      .cotizacion__media {
        max-width: 500px;
        margin: 0 auto;
      }
    }

    @media (max-width: 768px) {
      .modal-confirmation__content {
        width: 95%;
        padding: 2rem 1.5rem;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-confirmation__title {
        font-size: 1.4rem;
      }

      .modal-confirmation__subtitle {
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .modal-confirmation__icon {
        font-size: 3rem;
      }

      .modal-confirmation__details {
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .detail-row {
        flex-direction: column;
        gap: 0.25rem;
        padding: 0.6rem 0;
      }

      .detail-label {
        font-size: 0.85rem;
      }

      .detail-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: #0a4ba5;
      }

      .modal-confirmation__actions {
        flex-direction: column-reverse;
        gap: 0.6rem;
      }

      .modal-confirmation__actions .btn-primary,
      .modal-confirmation__actions .btn-secondary {
        width: 100%;
        padding: 0.9rem 1.5rem;
        font-size: 0.9rem;
      }

      .modal-confirmation__close {
        top: 0.8rem;
        right: 0.8rem;
        width: 32px;
        height: 32px;
        font-size: 1.3rem;
      }
    }

    @media (max-width: 640px) {
      .cotizacion {
        padding: 1.5rem 1rem;
      }
      .cotizacion__form {
        padding: 1.5rem;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .actions {
        flex-direction: column;
      }
      .btn-primary,
      .btn-secondary {
        width: 100%;
      }

      .modal-confirmation__content {
        width: calc(100% - 2rem);
        padding: 1.75rem 1.25rem;
        border-radius: 12px;
        max-height: 85vh;
      }

      .modal-confirmation__title {
        font-size: 1.3rem;
        margin-bottom: 0.4rem;
      }

      .modal-confirmation__subtitle {
        font-size: 0.85rem;
        margin-bottom: 1.25rem;
      }

      .modal-confirmation__icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .modal-confirmation__details {
        padding: 1rem;
        margin-bottom: 1.25rem;
      }

      .detail-row {
        padding: 0.5rem 0;
      }

      .detail-label {
        font-size: 0.8rem;
      }

      .detail-value {
        font-size: 0.85rem;
      }

      .modal-confirmation__close {
        top: 0.6rem;
        right: 0.6rem;
        width: 30px;
        height: 30px;
        font-size: 1.2rem;
        padding: 0.4rem 0.6rem;
      }
    }

    @media (max-width: 380px) {
      .modal-confirmation__content {
        width: calc(100% - 1rem);
        padding: 1.5rem 1rem;
      }

      .modal-confirmation__title {
        font-size: 1.15rem;
      }

      .modal-confirmation__subtitle {
        font-size: 0.8rem;
      }

      .modal-confirmation__details {
        padding: 0.85rem;
      }

      .modal-confirmation__actions .btn-primary,
      .modal-confirmation__actions .btn-secondary {
        padding: 0.8rem 1.25rem;
        font-size: 0.85rem;
      }
    }
  </style>

  <script type="module">
    // Sistema de modales elegantes
    class Modal {
      constructor() {
        this.overlay = document.createElement('div')
        this.overlay.className = 'modal-overlay'
        this.modal = document.createElement('div')
        this.modal.className = 'modal'
        this.overlay.appendChild(this.modal)
      }

      show(content, actions = []) {
        this.modal.innerHTML = `
          <div class="modal__content">${content}</div>
          <div class="modal__actions">
            ${actions.map(a => `<button class="btn ${a.variant || 'secondary'}" data-action="${a.label}">${a.label}</button>`).join('')}
          </div>
        `

        actions.forEach(action => {
          const btn = this.modal.querySelector(`[data-action="${action.label}"]`)
          btn?.addEventListener('click', () => {
            action.handler()
            this.close()
          })
        })

        document.body.appendChild(this.overlay)
        setTimeout(() => this.overlay.classList.add('show'), 10)
      }

      prompt(title, placeholder, callback) {
        this.modal.innerHTML = `
          <div class="modal__content">
            <h3>${title}</h3>
            <input type="text" class="modal__input" placeholder="${placeholder}" />
          </div>
          <div class="modal__actions">
            <button class="btn secondary" data-action="cancel">Cancelar</button>
            <button class="btn primary" data-action="confirm">Confirmar</button>
          </div>
        `

        const input = this.modal.querySelector('.modal__input')
        const cancelBtn = this.modal.querySelector('[data-action="cancel"]')
        const confirmBtn = this.modal.querySelector('[data-action="confirm"]')

        cancelBtn?.addEventListener('click', () => {
          callback(null)
          this.close()
        })

        confirmBtn?.addEventListener('click', () => {
          callback(input.value)
          this.close()
        })

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            callback(input.value)
            this.close()
          }
        })

        document.body.appendChild(this.overlay)
        setTimeout(() => {
          this.overlay.classList.add('show')
          input.focus()
        }, 10)
      }

      alert(message, variant = 'info') {
        const icons = {
          success: '‚úì',
          error: '‚úï',
          info: '‚Ñπ'
        }
        
        this.modal.innerHTML = `
          <div class="modal__content modal__content--${variant}">
            <div class="modal__icon">${icons[variant]}</div>
            <p>${message}</p>
          </div>
          <div class="modal__actions">
            <button class="btn primary" data-action="ok">OK</button>
          </div>
        `

        const okBtn = this.modal.querySelector('[data-action="ok"]')
        okBtn?.addEventListener('click', () => this.close())

        document.body.appendChild(this.overlay)
        setTimeout(() => this.overlay.classList.add('show'), 10)
      }

      close() {
        this.overlay.classList.remove('show')
        setTimeout(() => {
          if (this.overlay.parentNode) {
            this.overlay.parentNode.removeChild(this.overlay)
          }
        }, 200)
      }
    }

    const API_URL = 'http://localhost:3333'
    
    let currentCotizacionId = null

    // Elementos del DOM
    const salonSelect = document.getElementById('salon')
    const disposicionSelect = document.getElementById('disposicion')
    const form = document.getElementById('cotizacion-form')
    const successMessage = document.getElementById('success-message')
    const errorMessage = document.getElementById('error-message')
    const img = document.getElementById('salon-image')
    const title = document.getElementById('salon-title')
    const desc = document.getElementById('salon-description')
    const capacidadInfo = document.getElementById('capacidad-info')
    const precio4hInfo = document.getElementById('precio-4h-info')
    const precio8hInfo = document.getElementById('precio-8h-info')
    const asistentesInput = document.getElementById('asistentes')
    const capacidadInfoText = document.getElementById('capacidad-info-text')

    // Elementos para validaci√≥n de socio
    const soySocioCheckbox = document.getElementById('soy-socio')
    const codigoSocioContainer = document.getElementById('codigo-socio-container')
    const codigoSocioInput = document.getElementById('codigo-socio')
    const verificarCodigoBtn = document.getElementById('verificar-codigo-btn')
    const codigoSocioMensaje = document.getElementById('codigo-socio-mensaje')
    
    let codigoSocioValido = false
    let codigoSocioVerificado = null

    // Pre-seleccionar sal√≥n desde URL si viene el par√°metro
    function preseleccionarSalonDesdeURL() {
      const urlParams = new URLSearchParams(window.location.search)
      const salonParam = urlParams.get('salon')
      
      if (salonParam) {
        console.log('Pre-seleccionando sal√≥n desde URL:', salonParam)
        
        // Buscar la opci√≥n que coincida con el nombre del sal√≥n
        const opciones = salonSelect.options
        for (let i = 0; i < opciones.length; i++) {
          const opcionData = JSON.parse(opciones[i].value)
          if (opcionData.nombre.toLowerCase() === salonParam.toLowerCase()) {
            salonSelect.selectedIndex = i
            // Disparar el evento change para actualizar la UI
            salonSelect.dispatchEvent(new Event('change'))
            console.log('Sal√≥n pre-seleccionado:', opcionData.nombre)
            break
          }
        }
      }
    }

    const descriptions = {
      'MI LLANURA': 'Sal√≥n insignia con vista a las √°reas verdes, ambientaci√≥n adaptable. Ideal para recepciones, matrimonios y eventos corporativos.',
      'BAR': 'Ambiente contempor√°neo con barra integrada, iluminaci√≥n esc√©nica y sistema de sonido premium. Recomendado para cocteles y lanzamientos.',
      'EMPRESARIAL': 'Equipado con pantallas, streaming, mobiliario modular y conectividad para eventos corporativos, conferencias y workshops.',
      'TERRAZA': 'Espacio al aire libre con p√©rgolas y vistas; ideal para eventos sunset, bodas y recepciones.',
      'KIOSKO': '√Årea semiabierta rodeada de jardines, perfecta para reuniones familiares y celebraciones.',
      'PRESIDENTE': 'Espacio exclusivo con mobiliario ejecutivo, insonorizaci√≥n y servicio gourmet para reuniones privadas.'
    }

    // CONFIGURACI√ìN DE VALIDACI√ìN DE FECHAS (modifica estos valores seg√∫n necesites)
    const DIAS_MAXIMO_FUTURO = 30  // M√°ximo 30 d√≠as (1 mes) en el futuro
    const PERMITIR_HOY = true       // true = permitir reservas para hoy, false = solo futuras

    // Configurar restricciones de fecha en el input
    function configurarRestriccionesFecha() {
      const dateInput = document.getElementById('date')
      const hoy = new Date()
      
      // Obtener fecha local en formato YYYY-MM-DD sin conversi√≥n a UTC
      const year = hoy.getFullYear()
      const month = String(hoy.getMonth() + 1).padStart(2, '0')
      const day = String(hoy.getDate()).padStart(2, '0')
      const fechaHoyLocal = `${year}-${month}-${day}`
      
      // Fecha m√≠nima (hoy o ma√±ana)
      let minDate = fechaHoyLocal
      if (!PERMITIR_HOY) {
        const manana = new Date(hoy)
        manana.setDate(manana.getDate() + 1)
        const yearM = manana.getFullYear()
        const monthM = String(manana.getMonth() + 1).padStart(2, '0')
        const dayM = String(manana.getDate()).padStart(2, '0')
        minDate = `${yearM}-${monthM}-${dayM}`
      }
      
      // Fecha m√°xima (hoy + DIAS_MAXIMO_FUTURO)
      const fechaMax = new Date(hoy)
      fechaMax.setDate(fechaMax.getDate() + DIAS_MAXIMO_FUTURO)
      const yearMax = fechaMax.getFullYear()
      const monthMax = String(fechaMax.getMonth() + 1).padStart(2, '0')
      const dayMax = String(fechaMax.getDate()).padStart(2, '0')
      const maxDate = `${yearMax}-${monthMax}-${dayMax}`
      
      dateInput.setAttribute('min', minDate)
      dateInput.setAttribute('max', maxDate)
      
      console.log(`üìÖ Restricciones de fecha: min=${minDate}, max=${maxDate}`)
    }

    // Aplicar restricciones al cargar
    configurarRestriccionesFecha()

    // Horarios de operaci√≥n (formato 24 horas)
    const horarios = {
      0: { nombre: 'Domingo', activo: false, inicio: '‚Äî', fin: '‚Äî' },
      1: { nombre: 'Lunes', activo: false, inicio: '‚Äî', fin: '‚Äî' },
      2: { nombre: 'Martes', activo: true, inicio: '08:00', fin: '22:00' },
      3: { nombre: 'Mi√©rcoles', activo: true, inicio: '08:00', fin: '22:00' },
      4: { nombre: 'Jueves', activo: true, inicio: '08:00', fin: '22:00' },
      5: { nombre: 'Viernes', activo: true, inicio: '08:00', fin: '02:00' }, // 02:00 = 2 AM (ma√±ana siguiente)
      6: { nombre: 'S√°bado', activo: true, inicio: '08:00', fin: '02:00' }  // 02:00 = 2 AM (ma√±ana siguiente)
    }

    // CARGAR DISPOSICIONES DEL ESPACIO
    async function cargarDisposicionesDelEspacio(espacioId) {
      try {
        console.log('Cargando disposiciones para espacio:', espacioId)
        disposicionSelect.innerHTML = '<option value="">Cargando...</option>'
        
        const response = await fetch(`${API_URL}/api/espacios/${espacioId}/configuraciones`)
        const result = await response.json()
        
        console.log('Respuesta configuraciones:', result)
        
        if (result.success && result.data && result.data.length > 0) {
          // Agregar opci√≥n por defecto para obligar a seleccionar
          let html = '<option value="">Selecciona una disposici√≥n</option>'
          
          result.data.forEach(config => {
            try {
              const disposicionNombre = config.disposicion?.nombre || 'Sin nombre'
              const capacidad = config.capacidad || 0
              html += `<option value="${config.id}" data-capacidad="${capacidad}">
                ${disposicionNombre} (Capacidad: ${capacidad})
              </option>`
            } catch (e) {
              console.error('Error procesando config:', config, e)
            }
          })
          
          disposicionSelect.innerHTML = html
          console.log('Disposiciones cargadas:', result.data.length)
          
          // Limpiar la informaci√≥n de capacidad hasta que seleccionen una disposici√≥n
          capacidadInfoText.textContent = ''
        } else {
          console.warn('Sin datos:', result)
          disposicionSelect.innerHTML = '<option value="">No hay disposiciones</option>'
        }
      } catch (error) {
        console.error('Error:', error)
        disposicionSelect.innerHTML = '<option value="">Error</option>'
      }
    }

    // ACTUALIZAR CAPACIDAD CUANDO CAMBIA DISPOSICI√ìN
    function actualizarCapacidad() {
      const selected = disposicionSelect.selectedOptions[0]
      if (!selected || !selected.value) {
        // Si no hay disposici√≥n seleccionada, limpiar la info de capacidad
        capacidadInfoText.textContent = ''
        return
      }
      
      const capacidad = parseInt(selected.dataset.capacidad)
      capacidadInfoText.textContent = `(M√°x: ${capacidad})`
      asistentesInput.max = capacidad
      
      if (parseInt(asistentesInput.value) > capacidad) {
        asistentesInput.value = capacidad
      }
    }

    // CARGAR SERVICIOS
    async function cargarServicios() {
      try {
        const response = await fetch(`${API_URL}/api/servicios-adicionales/publico?activo=true`)
        const result = await response.json()
        
        if (result.success && result.data && result.data.length > 0) {
          const container = document.getElementById('servicios-checkboxes')
          let html = ''
          result.data.forEach(s => {
            html += `<label>
              <input type="checkbox" name="servicios" value="${s.id}" />
              ${s.nombre}
            </label>`
          })
          container.innerHTML = html
        } else {
          const container = document.getElementById('servicios-checkboxes')
          container.innerHTML = '<p style="color: #64748b; font-size: 0.9rem;">No hay servicios adicionales disponibles en este momento.</p>'
        }
      } catch (error) {
        console.error('Error cargando servicios:', error)
        const container = document.getElementById('servicios-checkboxes')
        container.innerHTML = '<p style="color: #ef4444; font-size: 0.9rem;">Error al cargar servicios adicionales.</p>'
      }
    }

    // CARGAR DISPOSICIONES CON DESCRIPCIONES DEL SAL√ìN ACTUAL
    async function cargarDisposicionesInfo(espacioId) {
      try {
        const response = await fetch(`${API_URL}/api/espacios/${espacioId}/configuraciones`)
        const result = await response.json()
        
        if (result.success && result.data) {
          const container = document.getElementById('disposiciones-contenido')
          let html = ''
          
          result.data.forEach(config => {
            const disp = config.disposicion
            if (disp && disp.descripcion) {
              html += `
                <div class="disposicion-card">
                  ${disp.imagen_url ? `<img src="${disp.imagen_url}" alt="${disp.nombre}" class="disposicion-card-imagen" />` : ''}
                  <strong class="disposicion-card-titulo">${disp.nombre}</strong>
                  <div class="disposicion-card-descripcion">${disp.descripcion}</div>
                </div>
              `
            }
          })
          
          if (html) {
            container.innerHTML = html
          } else {
            container.innerHTML = '<p style="text-align: center; color: #64748b; grid-column: 1/-1;">No hay informaci√≥n disponible</p>'
          }
        }
      } catch (error) {
        console.error('Error cargando disposiciones:', error)
        const container = document.getElementById('disposiciones-contenido')
        container.innerHTML = '<p style="text-align: center; color: #ef4444; grid-column: 1/-1;">Error al cargar las disposiciones</p>'
      }
    }

    // CARGAR TARIFAS DEL SAL√ìN
    async function cargarTarifas(espacioId) {
      try {
        precio4hInfo.textContent = '4 horas: Cargando...'
        precio8hInfo.textContent = '8 horas: Cargando...'
        
        const response = await fetch(`${API_URL}/api/espacios/${espacioId}/tarifas`)
        const data = await response.json()
        
        if (data.success) {
          const precio4h = data.data.precio4Horas 
            ? `$${data.data.precio4Horas.toLocaleString('es-CO')}` 
            : 'Consultar'
          const precio8h = data.data.precio8Horas 
            ? `$${data.data.precio8Horas.toLocaleString('es-CO')}` 
            : 'Consultar'
          
          precio4hInfo.textContent = `4 horas: ${precio4h}`
          precio8hInfo.textContent = `8 horas: ${precio8h}`
        }
      } catch (error) {
        console.error('Error cargando tarifas:', error)
      }
    }

    // CARGAR HORAS DISPONIBLES
    async function cargarHorasDisponibles(espacioId, fecha, duracion = 4) {
      const timeSelect = document.getElementById('time')
      const horasInfo = document.getElementById('horas-info')
      
      try {
        console.log(`Cargando horas para espacioId=${espacioId}, fecha=${fecha}, duracion=${duracion}`)
        timeSelect.innerHTML = '<option value="">Cargando horas...</option>'
        timeSelect.disabled = true
        horasInfo.style.display = 'none'
        
        const response = await fetch(`${API_URL}/api/disponibilidad/horas?espacioId=${espacioId}&fecha=${fecha}&duracion=${duracion}`)
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const result = await response.json()
        console.log('Respuesta horas disponibles:', result)
        
        if (result.success && result.data) {
          const horas = result.data.horasDisponibles
          
          if (horas.length === 0) {
            timeSelect.innerHTML = '<option value="">No hay horas disponibles</option>'
            horasInfo.textContent = result.data.mensaje || 'No hay horarios disponibles para esta fecha'
            horasInfo.style.display = 'block'
            horasInfo.style.color = '#dc2626'
            console.log('‚ö†Ô∏è Sin horas disponibles')
            return
          }
          
          let html = '<option value="">Selecciona una hora</option>'
          horas.forEach(hora => {
            html += `<option value="${hora}">${hora}</option>`
          })
          timeSelect.innerHTML = html
          timeSelect.disabled = false
          
          horasInfo.textContent = `‚úì ${horas.length} horarios disponibles`
          horasInfo.style.display = 'block'
          horasInfo.style.color = '#10b981'
          console.log(`‚úÖ ${horas.length} horas disponibles cargadas`)
        } else {
          throw new Error(result.message || 'Respuesta inv√°lida del servidor')
        }
      } catch (error) {
        console.error('‚ùå Error cargando horas:', error)
        timeSelect.innerHTML = '<option value="">Error al cargar (revisa servidor)</option>'
        horasInfo.textContent = 'Error: Verifica que el servidor backend est√© corriendo'
        horasInfo.style.display = 'block'
        horasInfo.style.color = '#dc2626'
      }
    }

    // EVENT: CAMBIO DE SAL√ìN
    salonSelect.addEventListener('change', async (e) => {
      try {
        const salonData = JSON.parse(e.target.value)
        const opt = e.target.selectedOptions[0]
        const imgSrc = opt.dataset.img
        const capacidad = opt.dataset.capacidad
        
        img.src = imgSrc
        title.textContent = salonData.nombre
        desc.textContent = descriptions[salonData.nombre] || ''
        capacidadInfo.textContent = `Capacidad: hasta ${capacidad} personas`
        
        // Cargar disposiciones del nuevo sal√≥n
        cargarDisposicionesDelEspacio(salonData.id)
        
        // Cargar info de disposiciones del nuevo sal√≥n
        cargarDisposicionesInfo(salonData.id)
        
        // Cargar tarifas del nuevo sal√≥n
        cargarTarifas(salonData.id)
        
        // Cargar horas disponibles si ya hay fecha seleccionada
        const dateInput = document.getElementById('date')
        if (dateInput.value) {
          const durationInput = document.getElementById('duration')
          const duracion = durationInput.value ? parseInt(durationInput.value) : 4
          await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
        }
      } catch (error) {
        console.error('Error al cambiar sal√≥n:', error)
      }
    })

    // EVENT: CAMBIO DE DISPOSICI√ìN
    disposicionSelect.addEventListener('change', actualizarCapacidad)

    // EVENT: CAMBIO DE FECHA - MOSTRAR HORARIO Y CARGAR HORAS
    const dateInput = document.getElementById('date')
    const horarioInfo = document.getElementById('horario-info')
    
    dateInput.addEventListener('change', async () => {
      if (!dateInput.value) {
        horarioInfo.style.display = 'none'
        document.getElementById('time').innerHTML = '<option value="">Selecciona primero la fecha</option>'
        document.getElementById('time').disabled = true
        return
      }
      
      const date = new Date(dateInput.value + 'T00:00:00')
      const diaSemana = date.getDay()
      const horario = horarios[diaSemana]
      
      if (horario) {
        if (horario.activo) {
          // Formato 24 horas expl√≠cito
          const horaInicioTexto = horario.inicio
          const horaFinTexto = horario.fin === '02:00' ? '02:00 ma√±ana siguiente' : horario.fin
          horarioInfo.innerHTML = `<strong>üìÖ ${horario.nombre}</strong> - Horario: ${horaInicioTexto} a ${horaFinTexto}`
          horarioInfo.style.background = '#ecfdf5'
          horarioInfo.style.borderLeftColor = '#10b981'
          horarioInfo.style.color = '#065f46'
        } else {
          horarioInfo.innerHTML = `<strong>‚õî ${horario.nombre}</strong> - El club est√° cerrado este d√≠a`
          horarioInfo.style.background = '#fef2f2'
          horarioInfo.style.borderLeftColor = '#dc2626'
          horarioInfo.style.color = '#991b1b'
          document.getElementById('time').innerHTML = '<option value="">Club cerrado este d√≠a</option>'
          document.getElementById('time').disabled = true
          document.getElementById('horas-info').style.display = 'none'
          horarioInfo.style.display = 'block'
          return
        }
        horarioInfo.style.display = 'block'
      }
      
      // Cargar horas disponibles si hay sal√≥n seleccionado
      const salonSelect = document.getElementById('salon')
      if (salonSelect.value) {
        const salonData = JSON.parse(salonSelect.value)
        const durationInput = document.getElementById('duration')
        const duracion = durationInput.value ? parseInt(durationInput.value) : 4
        await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
      } else {
        document.getElementById('time').innerHTML = '<option value="">Selecciona primero el sal√≥n</option>'
        document.getElementById('time').disabled = true
      }
    })

    // MANEJAR CHECKBOX "SOY SOCIO"
    soySocioCheckbox?.addEventListener('change', (e) => {
      const isChecked = e.target.checked
      
      if (isChecked) {
        codigoSocioContainer.style.display = 'block'
        codigoSocioInput.required = true
      } else {
        codigoSocioContainer.style.display = 'none'
        codigoSocioInput.required = false
        codigoSocioInput.value = ''
        codigoSocioValido = false
        codigoSocioVerificado = null
        codigoSocioMensaje.style.display = 'none'
        codigoSocioMensaje.className = ''
      }
    })

    // VALIDAR C√ìDIGO DE SOCIO
    async function validarCodigoSocio(codigo) {
      if (!codigo || codigo.trim() === '') {
        codigoSocioMensaje.textContent = 'Ingresa un c√≥digo de socio'
        codigoSocioMensaje.className = 'invalido'
        codigoSocioMensaje.style.display = 'block'
        codigoSocioValido = false
        return false
      }

      verificarCodigoBtn.disabled = true
      verificarCodigoBtn.textContent = 'Verificando...'

      try {
        const response = await fetch(`${API_URL}/api/socios/buscar?codigo=${encodeURIComponent(codigo.trim())}`)
        const result = await response.json()

        if (result.success && result.data && result.data.activo) {
          codigoSocioMensaje.textContent = '‚úì C√≥digo v√°lido'
          codigoSocioMensaje.className = 'valido'
          codigoSocioMensaje.style.display = 'block'
          codigoSocioValido = true
          codigoSocioVerificado = codigo.trim()
          return true
        } else {
          codigoSocioMensaje.textContent = '‚úï C√≥digo inv√°lido'
          codigoSocioMensaje.className = 'invalido'
          codigoSocioMensaje.style.display = 'block'
          codigoSocioValido = false
          codigoSocioVerificado = null
          return false
        }
      } catch (error) {
        console.error('Error validando c√≥digo de socio:', error)
        codigoSocioMensaje.textContent = '‚úï Error al validar c√≥digo'
        codigoSocioMensaje.className = 'invalido'
        codigoSocioMensaje.style.display = 'block'
        codigoSocioValido = false
        codigoSocioVerificado = null
        return false
      } finally {
        verificarCodigoBtn.disabled = false
        verificarCodigoBtn.textContent = 'Verificar'
      }
    }

    // EVENTO VERIFICAR C√ìDIGO
    verificarCodigoBtn?.addEventListener('click', async () => {
      await validarCodigoSocio(codigoSocioInput.value)
    })

    // VALIDAR AL PRESIONAR ENTER EN EL INPUT
    codigoSocioInput?.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault()
        await validarCodigoSocio(codigoSocioInput.value)
      }
    })

    // RESETEAR VALIDACI√ìN AL CAMBIAR EL C√ìDIGO
    codigoSocioInput?.addEventListener('input', () => {
      if (codigoSocioValido) {
        codigoSocioMensaje.style.display = 'none'
        codigoSocioValido = false
        codigoSocioVerificado = null
      }
    })

    // CALCULAR Y MOSTRAR HORA FINAL
    function calcularHoraFinal() {
      const timeSelect = document.getElementById('time')
      const durationInput = document.getElementById('duration')
      const horaFinalInput = document.getElementById('hora-final')
      const duracionInfo = document.getElementById('duracion-info')
      
      // Limpiar si no hay hora de inicio
      if (!timeSelect.value || timeSelect.value === '' || !durationInput.value) {
        horaFinalInput.value = 'Selecciona hora de inicio'
        duracionInfo.style.display = 'none'
        return
      }
      
      const horaInicio = timeSelect.value // formato "HH:mm"
      const duracion = parseInt(durationInput.value)
      
      // Parsear hora de inicio
      const [horas, minutos] = horaInicio.split(':').map(Number)
      
      // Calcular hora final
      let horaFinal = horas + duracion
      const minutosFinal = minutos
      
      // Ajustar si pasa de 24 horas
      if (horaFinal >= 24) {
        horaFinal = horaFinal - 24
      }
      
      // Formatear hora final
      const horaFinalStr = `${String(horaFinal).padStart(2, '0')}:${String(minutosFinal).padStart(2, '0')}`
      
      horaFinalInput.value = horaFinalStr
      duracionInfo.style.display = 'none'
      
      console.log(`üìÖ Hora calculada: ${horaInicio} + ${duracion}h = ${horaFinalStr}`)
    }

    // EVENT: CAMBIO DE DURACI√ìN - RECARGAR HORAS DISPONIBLES Y RECALCULAR HORA FINAL
    const durationInput = document.getElementById('duration')
    durationInput.addEventListener('change', async () => {
      const salonSelect = document.getElementById('salon')
      const dateInput = document.getElementById('date')
      const timeSelect = document.getElementById('time')
      
      // Validar m√≠nimo 4 horas
      const duracionValue = parseInt(durationInput.value)
      if (duracionValue < 4) {
        const modal = new Modal()
        modal.alert('La duraci√≥n m√≠nima es de 4 horas', 'error')
        durationInput.value = 4
        return
      }
      
      // Validar m√°ximo 8 horas para clientes
      if (duracionValue > 8) {
        const modal = new Modal()
        modal.alert('La duraci√≥n m√°xima para clientes es de 8 horas. Horas adicionales se cobran por separado.', 'info')
        durationInput.value = 8
        return
      }
      
      // Guardar la hora de inicio seleccionada antes de recargar
      const horaInicioPrevia = timeSelect.value
      
      // Recalcular hora final con la nueva duraci√≥n
      calcularHoraFinal()
      
      // Solo recargar si ya hay sal√≥n y fecha seleccionados
      if (salonSelect.value && dateInput.value) {
        const salonData = JSON.parse(salonSelect.value)
        const duracion = durationInput.value ? parseInt(durationInput.value) : 4
        await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
        
        // Restaurar la hora de inicio si sigue siendo v√°lida en las nuevas opciones
        if (horaInicioPrevia) {
          // Verificar si la hora previa existe en las nuevas opciones
          const options = Array.from(timeSelect.options).map(opt => opt.value)
          if (options.includes(horaInicioPrevia)) {
            timeSelect.value = horaInicioPrevia
            calcularHoraFinal() // Recalcular con la hora restaurada
          }
        }
      }
    })

    // EVENT: CAMBIO DE HORA DE INICIO - CALCULAR HORA FINAL
    const timeSelect = document.getElementById('time')
    timeSelect.addEventListener('change', () => {
      calcularHoraFinal()
    })

    // EVENT: VALIDAR ASISTENTES
    asistentesInput.addEventListener('change', () => {
      const selected = disposicionSelect.selectedOptions[0]
      if (!selected) return
      
      const capacidad = parseInt(selected.dataset.capacidad)
      const asistentes = parseInt(asistentesInput.value)
      
      if (asistentes > capacidad) {
        const modal = new Modal()
        modal.alert(`M√°ximo ${capacidad} personas para esta disposici√≥n`, 'error')
        asistentesInput.value = capacidad
      }
    })

    // FUNCI√ìN PARA MOSTRAR MODAL DE CONFIRMACI√ìN
    function mostrarModalConfirmacion(salonData, servicios) {
      console.log('Mostrando modal de confirmaci√≥n', salonData, servicios)
      const modal = document.getElementById('confirmation-modal')
      console.log('Modal element:', modal)
      
      // Llenar datos del modal
      document.getElementById('confirm-salon').textContent = salonData.nombre
      
      const fechaInput = document.getElementById('date').value
      const fecha = new Date(fechaInput + 'T00:00:00')
      const fechaFormateada = fecha.toLocaleDateString('es-CO', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      })
      document.getElementById('confirm-fecha').textContent = fechaFormateada
      
      const horaInicio = document.getElementById('time').value
      document.getElementById('confirm-hora-inicio').textContent = horaInicio
      
      const horaFinElement = document.getElementById('hora-final')
      const horaFin = horaFinElement ? horaFinElement.value : 'No disponible'
      document.getElementById('confirm-hora-fin').textContent = horaFin
      
      const duracion = document.getElementById('duration').value
      document.getElementById('confirm-duracion').textContent = `${duracion} horas`
      
      const asistentes = document.getElementById('asistentes').value
      document.getElementById('confirm-asistentes').textContent = asistentes
      
      // Tipo de cliente (socio o particular)
      const socioRow = document.getElementById('confirm-socio-row')
      if (soySocioCheckbox.checked && codigoSocioValido) {
        socioRow.style.display = 'flex'
      } else {
        socioRow.style.display = 'none'
      }
      
      // Servicios adicionales
      const serviciosRow = document.getElementById('confirm-servicios-row')
      if (servicios.length > 0) {
        const serviciosCheckboxes = Array.from(form.querySelectorAll('input[name="servicios"]:checked'))
        const serviciosNombres = serviciosCheckboxes.map(cb => cb.parentElement.textContent.trim())
        document.getElementById('confirm-servicios').textContent = serviciosNombres.join(', ')
        serviciosRow.style.display = 'flex'
      } else {
        serviciosRow.style.display = 'none'
      }
      
      modal.hidden = false
    }

    // FUNCI√ìN PARA ENVIAR COTIZACI√ìN
    async function enviarCotizacion() {
      const salonData = JSON.parse(salonSelect.value)
      const servicios = Array.from(form.querySelectorAll('input[name="servicios"]:checked')).map(i => parseInt(i.value))

      // Determinar tipo de cliente y c√≥digo de socio
      const esSocio = soySocioCheckbox.checked && codigoSocioValido
      const tipoCliente = esSocio ? 'socio' : 'particular'
      
      console.log('üîç Verificando tipo de cliente:', {
        checkboxMarcado: soySocioCheckbox.checked,
        codigoValido: codigoSocioValido,
        esSocio: esSocio,
        tipoCliente: tipoCliente,
        codigoVerificado: codigoSocioVerificado
      })
      
      const cotizacionData = {
        espacioId: salonData.id,
        configuracionEspacioId: parseInt(disposicionSelect.value),
        fecha: document.getElementById('date').value,
        horaInicio: document.getElementById('time').value,
        duracion: parseInt(document.getElementById('duration').value),
        tipoEvento: document.getElementById('tipoEvento').value,
        asistentes: parseInt(asistentesInput.value),
        tipoCliente: tipoCliente,
        ...(esSocio && codigoSocioVerificado ? { codigoSocio: codigoSocioVerificado } : {}),
        servicios,
        nombre: document.getElementById('nombre').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value || undefined,
        observaciones: document.getElementById('observaciones').value || undefined,
      }

      successMessage.hidden = true
      errorMessage.hidden = true

      const submitBtn = form.querySelector('button[type="submit"]')
      const originalText = submitBtn.textContent
      submitBtn.disabled = true
      submitBtn.textContent = 'Enviando...'

      console.log('üì§ Enviando datos al backend:', cotizacionData)

      try {
        const response = await fetch(`${API_URL}/api/cotizaciones`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cotizacionData),
        })

        const result = await response.json()

        if (result.success && result.data) {
          // Verificar si hay disponibilidad
          if (!result.data.disponible) {
            document.getElementById('error-text').textContent = `No hay disponibilidad: ${result.data.mensajeDisponibilidad || 'Fecha/hora no disponible'}`
            errorMessage.hidden = false
            return
          }
          
          currentCotizacionId = result.data.cotizacion.id
          document.getElementById('cotizacion-numero').textContent = `#${result.data.cotizacion.cotizacionNumero}`
          document.getElementById('cotizacion-total').textContent = `$${result.data.cotizacion.valorTotal.toLocaleString('es-CO')}`
          document.getElementById('cotizacion-abono').textContent = `$${result.data.montoAbono.toLocaleString('es-CO')}`
          
          successMessage.hidden = false
          form.style.display = 'none'
        } else {
          document.getElementById('error-text').textContent = result.message || 'Error'
          errorMessage.hidden = false
        }
      } catch (error) {
        document.getElementById('error-text').textContent = 'Error de conexi√≥n'
        errorMessage.hidden = false
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = originalText
      }
    }

    // ENVIAR FORMULARIO
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      console.log('Form submitted')

      // VALIDAR
      if (!disposicionSelect.value) {
        const modal = new Modal()
        modal.alert('Selecciona una disposici√≥n', 'error')
        return
      }

      // VALIDAR C√ìDIGO DE SOCIO SI EST√Å MARCADO
      if (soySocioCheckbox.checked) {
        if (!codigoSocioInput.value || codigoSocioInput.value.trim() === '') {
          const modal = new Modal()
          modal.alert('Ingresa tu c√≥digo de socio', 'error')
          codigoSocioInput.focus()
          return
        }
        
        if (!codigoSocioValido || codigoSocioVerificado !== codigoSocioInput.value.trim()) {
          const modal = new Modal()
          modal.alert('Debes verificar tu c√≥digo de socio antes de continuar', 'error')
          verificarCodigoBtn.focus()
          return
        }
      }

      const selected = disposicionSelect.selectedOptions[0]
      const capacidad = parseInt(selected.dataset.capacidad)
      const asistentes = parseInt(asistentesInput.value)
      
      console.log('Validando asistentes:', asistentes, 'capacidad:', capacidad)
      
      if (asistentes > capacidad) {
        const modal = new Modal()
        modal.alert(`M√°ximo ${capacidad} personas`, 'error')
        return
      }

      console.log('Parseando salonData...')
      const salonData = JSON.parse(salonSelect.value)
      const servicios = Array.from(form.querySelectorAll('input[name="servicios"]:checked')).map(i => parseInt(i.value))

      console.log('Llamando mostrarModalConfirmacion...')
      // Mostrar modal de confirmaci√≥n
      mostrarModalConfirmacion(salonData, servicios)
    })

    // BOTONES DE ACCI√ìN
    document.getElementById('view-pdf-btn')?.addEventListener('click', () => {
      if (currentCotizacionId) {
        window.open(`${API_URL}/api/cotizaciones/${currentCotizacionId}/pdf`, '_blank')
      }
    })

    document.getElementById('download-pdf-btn')?.addEventListener('click', () => {
      if (currentCotizacionId) {
        window.open(`${API_URL}/api/cotizaciones/${currentCotizacionId}/pdf`, '_blank')
      }
    })

    document.getElementById('nueva-cotizacion-btn')?.addEventListener('click', () => {
      form.style.display = 'block'
      form.reset()
      successMessage.hidden = true
      currentCotizacionId = null
      
      // Resetear campos de socio
      soySocioCheckbox.checked = false
      codigoSocioContainer.style.display = 'none'
      codigoSocioInput.required = false
      codigoSocioInput.value = ''
      codigoSocioValido = false
      codigoSocioVerificado = null
      codigoSocioMensaje.style.display = 'none'
      codigoSocioMensaje.className = ''
      
      cargarDisposicionesDelEspacio(1) // Reset a MI LLANURA
      window.scrollTo({ top: 0, behavior: 'smooth' })
    })

    // BOTONES DE ERROR MODAL
    document.getElementById('close-error-btn')?.addEventListener('click', () => {
      errorMessage.hidden = true
    })

    document.getElementById('retry-btn')?.addEventListener('click', () => {
      errorMessage.hidden = true
    })

    // BOTONES DE CONFIRMACI√ìN MODAL
    const confirmationModal = document.getElementById('confirmation-modal')
    
    document.getElementById('close-confirmation-btn')?.addEventListener('click', () => {
      confirmationModal.hidden = true
    })

    document.getElementById('cancel-confirmation-btn')?.addEventListener('click', () => {
      confirmationModal.hidden = true
    })

    document.getElementById('submit-confirmation-btn')?.addEventListener('click', async () => {
      confirmationModal.hidden = true
      await enviarCotizacion()
    })

    // Cerrar modales al hacer clic en el overlay
    const errorModal = document.getElementById('error-message')
    if (errorModal) {
      errorModal.addEventListener('click', (e) => {
        if (e.target === errorModal || e.target.classList.contains('modal-error__overlay')) {
          errorModal.hidden = true
        }
      })
    }

    if (confirmationModal) {
      confirmationModal.addEventListener('click', (e) => {
        if (e.target === confirmationModal || e.target.classList.contains('modal-confirmation__overlay')) {
          confirmationModal.hidden = true
        }
      })
    }

    // INICIALIZAR
    console.log('Iniciando...')
    cargarServicios()
    
    // Pre-seleccionar sal√≥n desde URL si viene el par√°metro
    preseleccionarSalonDesdeURL()
    
    // Cargar datos del sal√≥n seleccionado (por defecto el primero o el pre-seleccionado)
    const salonInicial = JSON.parse(salonSelect.value)
    cargarTarifas(salonInicial.id)
    cargarDisposicionesDelEspacio(salonInicial.id)
    cargarDisposicionesInfo(salonInicial.id)
  </script>

</BaseLayout>
