---
import BaseLayout from '../layouts/BaseLayout.astro'
import millanuraImg from '../assets/millanura.jpg'
import barImg from '../assets/bar.jpg'
import empresarialImg from '../assets/empresarial.jpg'
import terrazaImg from '../assets/terraza.jpg'
import kioskoImg from '../assets/kiosko.jpg'
import presidencialImg from '../assets/presidencial.jpg'

const imageMap = {
  'MI LLANURA': millanuraImg,
  'BAR': barImg,
  'EMPRESARIAL': empresarialImg,
  'TERRAZA': terrazaImg,
  'KIOSKO': kioskoImg,
  'PRESIDENTE': presidencialImg,
}

// Datos estáticos para build
const espacios = [
  { id: 1, nombre: 'MI LLANURA', capacidadMaxima: 100 },
  { id: 2, nombre: 'BAR', capacidadMaxima: 60 },
  { id: 3, nombre: 'EMPRESARIAL', capacidadMaxima: 35 },
  { id: 4, nombre: 'TERRAZA', capacidadMaxima: 30 },
  { id: 5, nombre: 'KIOSKO', capacidadMaxima: 60 },
  { id: 6, nombre: 'PRESIDENTE', capacidadMaxima: 15 },
]
---

<BaseLayout title="Obtener cotización - Club del Meta">
  <section class="cotizacion">
    <header class="cotizacion__header">
      <h1>Solicita tu cotización</h1>
      <p>Selecciona el salón, completa los datos y te enviaremos una propuesta personalizada lo antes posible.</p>
    </header>

    <div class="cotizacion__container">
      <aside class="cotizacion__media">
        <img id="salon-image" src={millanuraImg.src} alt="Imagen del salón seleccionado" />
        <div class="salon-info">
          <h2 id="salon-title">MI LLANURA</h2>
          <p id="salon-description">Salón insignia con vista a las áreas verdes, ambientación adaptable. Ideal para recepciones, matrimonios y eventos corporativos.</p>
          <ul id="salon-features">
            <li id="capacidad-info">Capacidad: hasta 100 personas</li>
            <li>Climatización</li>
            <li>Conexión eléctrica para catering y sonido</li>
            <li>Acceso para proveedores</li>
          </ul>
        </div>
      </aside>

      <main class="cotizacion__form">
        <form id="cotizacion-form">
          <div class="field">
            <label for="salon">Salón</label>
            <select id="salon" name="salon" required>
              {espacios.map((espacio) => {
                const imgSrc = imageMap[espacio.nombre]?.src || millanuraImg.src
                return (
                  <option 
                    value={espacio.nombre} 
                    data-img={imgSrc}
                    data-capacidad={espacio.capacidadMaxima}
                  >
                    {espacio.nombre}
                  </option>
                )
              })}
            </select>
          </div>

          <div class="field grid-2">
            <div>
              <label for="date">Fecha</label>
              <input id="date" name="date" type="date" required />
            </div>
            <div>
              <label for="time">Hora de inicio</label>
              <input id="time" name="time" type="time" required />
            </div>
          </div>

          <div class="field grid-2">
            <div>
              <label for="duration">Duración (horas)</label>
              <input id="duration" name="duration" type="number" min="1" max="72" value="4" required />
            </div>
            <div>
              <label for="guests">Cantidad estimada de asistentes</label>
              <input id="guests" name="guests" type="number" min="1" value="50" />
            </div>
          </div>

          <fieldset class="field">
            <legend>Prestaciones / servicios</legend>
            <div class="checkboxes">
              <label><input type="checkbox" name="features" value="Sillas" /> Sillas</label>
              <label><input type="checkbox" name="features" value="Mesas" /> Mesas</label>
              <label><input type="checkbox" name="features" value="Sonido" /> Sonido</label>
              <label><input type="checkbox" name="features" value="Iluminación" /> Iluminación</label>
              <label><input type="checkbox" name="features" value="Proyector" /> Proyector / Pantalla</label>
              <label><input type="checkbox" name="features" value="WiFi" /> WiFi</label>
              <label><input type="checkbox" name="features" value="Catering" /> Catering</label>
              <label><input type="checkbox" name="features" value="Personal" /> Personal de apoyo</label>
              <label><input type="checkbox" name="features" value="Estacionamiento" /> Estacionamiento</label>
            </div>
          </fieldset>

          <div class="field grid-2">
            <div>
              <label><input id="need-chairs" name="needChairs" type="checkbox" /> Requiere sillas</label>
            </div>
            <div>
              <label for="chairs-count">Número de sillas (si aplica)</label>
              <input id="chairs-count" name="chairsCount" type="number" min="0" value="0" />
            </div>
          </div>

          <div class="field">
            <label for="name">Nombre de contacto</label>
            <input id="name" name="name" type="text" required />
          </div>

          <div class="field grid-2">
            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required />
            </div>
            <div>
              <label for="phone">Teléfono</label>
              <input id="phone" name="phone" type="tel" />
            </div>
          </div>

          <div class="field">
            <label for="notes">Observaciones adicionales</label>
            <textarea id="notes" name="notes" rows="4" placeholder="Especifica detalles como montaje, accesos, restricciones, etc."></textarea>
          </div>

          <div class="actions">
            <button type="submit">Solicitar cotización</button>
            <button type="button" id="reset-btn" class="secondary">Limpiar</button>
          </div>
        </form>

        <div id="success-message" class="success-message" hidden>
          <h3>¡Cotización solicitada exitosamente!</h3>
          <p>Tu cotización <strong id="cotizacion-numero"></strong> ha sido generada.</p>
          <p>Valor total estimado: <strong id="cotizacion-total"></strong></p>
          <button type="button" id="download-pdf-btn" class="download-btn">Descargar cotización en PDF</button>
          <button type="button" id="nueva-cotizacion-btn" class="secondary">Nueva cotización</button>
        </div>
        
        <div id="error-message" class="error-message" hidden>
          <h3>Error al procesar la cotización</h3>
          <p id="error-text"></p>
          <button type="button" id="retry-btn" class="secondary">Intentar nuevamente</button>
        </div>
      </main>
    </div>
  </section>

  <style>
    .cotizacion { padding: 3rem 2rem; max-width: 1200px; margin: 0 auto; }
    .cotizacion__header h1 { font-size: clamp(2rem,5vw,3rem); margin: 0 0 .5rem; }
    .cotizacion__container { display: grid; grid-template-columns: 420px 1fr; gap: 2rem; align-items: start; }

    .cotizacion__media img { width: 100%; border-radius: 12px; object-fit: cover; height: 260px; display: block; }
    .salon-info { margin-top: 1rem; color: #374151; }
    .salon-info h2 { margin: 0 0 .25rem; font-size: 1.25rem; }
    .salon-info p { margin: 0 0 .5rem; color: #6b7280; }
    .salon-info ul { margin: .25rem 0 0; padding-left: 1.1rem; color: #374151; }

    form { background: #fff; padding: 1.25rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(2,6,23,0.06); }
    .field { margin-bottom: 1rem; }
    label { display:block; font-weight:600; margin-bottom: .4rem; color:#111827 }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
      width:100%; padding:.6rem .75rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff; box-sizing:border-box;
    }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap: .75rem; }
    fieldset { border:1px solid #e6eef6; padding:.75rem; border-radius:8px; }
    .checkboxes { display:grid; grid-template-columns: repeat(2, 1fr); gap:.5rem; }
    .actions { display:flex; gap:.75rem; margin-top: .5rem; }
    button { padding:.6rem .95rem; border-radius:999px; border:none; background:#0a4ba5; color:#fff; cursor:pointer; font-weight:700 }
    .secondary { background:transparent; border:1px solid #c7d2fe; color:#0a4ba5 }

    .summary { margin-top:1rem; background:#f8fafc; padding:1rem; border-radius:8px; }
    .summary pre { white-space:pre-wrap; word-break:break-word; margin:0; }
    
    .success-message { margin-top:1rem; background:#ecfdf5; padding:1.5rem; border-radius:8px; border:1px solid #86efac; }
    .success-message h3 { color:#065f46; margin:0 0 .5rem; }
    .success-message p { color:#047857; margin:.25rem 0; }
    .download-btn { background:#059669; margin-top:.75rem; }
    .download-btn:hover { background:#047857; }
    
    .error-message { margin-top:1rem; background:#fef2f2; padding:1.5rem; border-radius:8px; border:1px solid #fca5a5; }
    .error-message h3 { color:#991b1b; margin:0 0 .5rem; }
    .error-message p { color:#dc2626; margin:.25rem 0; }

    @media (max-width: 900px) { .cotizacion__container { grid-template-columns: 1fr; } }
  </style>

  <script type="module">
    // API Service inline
    const API_URL = 'http://localhost:3333'
    
    const cotizacionesAPI = {
      async crear(data) {
        try {
          const response = await fetch(`${API_URL}/api/cotizaciones`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          })
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`)
          return await response.json()
        } catch (error) {
          console.error('Error creando cotización:', error)
          return {
            success: false,
            message: 'Error al crear la cotización',
            error: error instanceof Error ? error.message : 'Unknown error',
          }
        }
      },
      getPdfUrl(cotizacionId) {
        return `${API_URL}/api/cotizaciones/${cotizacionId}/pdf`
      },
      async descargarPdf(cotizacionId) {
        try {
          const url = this.getPdfUrl(cotizacionId)
          window.open(url, '_blank')
        } catch (error) {
          console.error('Error descargando PDF:', error)
          throw error
        }
      },
    }
    
    const salonSelect = document.getElementById('salon')
    const img = document.getElementById('salon-image')
    const title = document.getElementById('salon-title')
    const desc = document.getElementById('salon-description')
    const capacidadInfo = document.getElementById('capacidad-info')

    const descriptions = {
      'MI LLANURA': 'Salón insignia con vista a las áreas verdes, ambientación adaptable. Ideal para recepciones, matrimonios y eventos corporativos.',
      'BAR': 'Ambiente contemporáneo con barra integrada, iluminación escénica y sistema de sonido premium. Recomendado para cocteles y lanzamientos.',
      'EMPRESARIAL': 'Equipado con pantallas, streaming, mobiliario modular y conectividad para eventos corporativos, conferencias y workshops.',
      'TERRAZA': 'Espacio al aire libre con pérgolas y vistas; ideal para eventos sunset, bodas y recepciones.',
      'KIOSKO': 'Área semiabierta rodeada de jardines, perfecta para reuniones familiares y celebraciones.',
      'PRESIDENTE': 'Espacio exclusivo con mobiliario ejecutivo, insonorización y servicio gourmet para reuniones privadas.'
    }

    // If a salon is provided as query param, preselect it and trigger change
    try {
      const params = new URLSearchParams(location.search)
      const salonParam = params.get('salon')
      if (salonParam) {
        const match = Array.from(salonSelect.options).find((o) => o.value === salonParam)
        if (match) {
          salonSelect.value = salonParam
          salonSelect.dispatchEvent(new Event('change', { bubbles: true }))
        }
      }
    } catch (err) {
      // ignore if location is not available (SSR) or any other issue
    }

    salonSelect.addEventListener('change', (e) => {
      const opt = e.target.selectedOptions[0]
      const imgSrc = opt.dataset.img
      const name = opt.value
      const capacidad = opt.dataset.capacidad
      
      img.src = imgSrc
      title.textContent = name
      desc.textContent = descriptions[name] || ''
      capacidadInfo.textContent = `Capacidad: hasta ${capacidad} personas`
    })

    const form = document.getElementById('cotizacion-form')
    const successMessage = document.getElementById('success-message')
    const errorMessage = document.getElementById('error-message')
    const resetBtn = document.getElementById('reset-btn')

    let currentCotizacionId = null

    resetBtn.addEventListener('click', () => { 
      form.reset()
      successMessage.hidden = true
      errorMessage.hidden = true
      currentCotizacionId = null
    })

    document.getElementById('nueva-cotizacion-btn')?.addEventListener('click', () => {
      form.reset()
      successMessage.hidden = true
      errorMessage.hidden = true
      currentCotizacionId = null
    })

    document.getElementById('retry-btn')?.addEventListener('click', () => {
      errorMessage.hidden = true
    })

    document.getElementById('download-pdf-btn')?.addEventListener('click', () => {
      if (currentCotizacionId) {
        cotizacionesAPI.descargarPdf(currentCotizacionId)
      }
    })

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const data = new FormData(form)
      const values = Object.fromEntries(data.entries())
      
      // features can be multiple
      const features = Array.from(form.querySelectorAll('input[name="features"]:checked')).map(i => i.value)
      
      const needChairs = form.querySelector('#need-chairs').checked
      const chairsCount = parseInt(form.querySelector('#chairs-count').value || '0')

      // basic validation
      if (!values.salon || !values.date || !values.time || !values.name || !values.email) {
        alert('Por favor completa los campos requeridos: salón, fecha, hora, nombre y email.')
        return
      }

      // Prepare data for API
      const cotizacionData = {
        salon: values.salon,
        fecha: values.date,
        hora: values.time,
        duracion: parseInt(values.duration),
        asistentes: parseInt(values.guests),
        prestaciones: features,
        requiereSillas: needChairs,
        numeroSillas: chairsCount,
        nombre: values.name,
        email: values.email,
        telefono: values.phone || undefined,
        observaciones: values.notes || undefined
      }

      // Hide previous messages
      successMessage.hidden = true
      errorMessage.hidden = true

      // Show loading state
      const submitBtn = form.querySelector('button[type="submit"]')
      const originalText = submitBtn.textContent
      submitBtn.disabled = true
      submitBtn.textContent = 'Procesando...'

      try {
        const response = await cotizacionesAPI.crear(cotizacionData)

        if (response.success && response.data) {
          currentCotizacionId = response.data.id
          document.getElementById('cotizacion-numero').textContent = `#${response.data.cotizacionNumero}`
          document.getElementById('cotizacion-total').textContent = `$${response.data.valorTotal.toLocaleString('es-CO')}`
          successMessage.hidden = false
          form.reset()
        } else {
          document.getElementById('error-text').textContent = response.message || 'Ocurrió un error al procesar la cotización'
          errorMessage.hidden = false
        }
      } catch (error) {
        document.getElementById('error-text').textContent = 'Error de conexión. Por favor verifica tu conexión a internet e intenta nuevamente.'
        errorMessage.hidden = false
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = originalText
      }
    })
  </script>

</BaseLayout>
